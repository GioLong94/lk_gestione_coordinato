<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestione Coordinato</title>

<style>
*{box-sizing:border-box}
body{font-family:Segoe UI;padding:20px;background:#f5f5f5;max-width:1200px;margin:auto}
.section{background:#fff;padding:20px;margin-bottom:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
h1,h2,h3{margin-bottom:10px}
input,textarea{padding:8px;border:1px solid #ccc;border-radius:4px}
textarea{width:100%;min-height:120px}
button{padding:8px 15px;border:none;border-radius:4px;cursor:pointer;margin-top:5px}
.btn-primary{background:#4CAF50;color:#fff}
.btn-secondary{background:#2196F3;color:#fff}
.btn-danger{background:#f44336;color:#fff}
.card{border:1px solid #ddd;padding:10px;margin-bottom:8px;border-radius:5px;background:#fafafa}
.hidden{display:none}
.help{background:#2196F3;color:#fff;width:18px;height:18px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer}
.tooltip{margin-top:6px;padding:8px;background:#eef5ff;border-left:4px solid #2196F3;border-radius:4px}
.error{color:red;margin-top:5px;font-size:13px;}
</style>
</head>

<body>

<h1>Gestione Coordinato</h1>

<!-- Impatto principale -->
<div class="section">
<h2>‚è±Ô∏è Impatto principale</h2>
Giorno <input id="giorno" placeholder="GG/MM"><div id="errGiorno" class="error hidden">Campo obbligatorio</div><br>
Ora <input id="ora" placeholder="HH:MM"><div id="errOra" class="error hidden">Campo obbligatorio</div>
</div>

<!-- Attaccanti -->
<div class="section">
<h2>‚ûï Aggiungi attaccante <span class="help" onclick="toggleHelp('h1')">?</span></h2>
<div id="h1" class="tooltip hidden">Inserisci nome e truppe OFF disponibili.</div>

Nome <input id="nome"><div id="errNome" class="error hidden">Campo obbligatorio</div><br><br>
OFF <input id="off" type="number"><div id="errOff" class="error hidden">Campo obbligatorio</div><br><br>

<h3>Argento disponibile <span class="help" onclick="toggleHelp('h2')">?</span></h3>
<div id="h2" class="tooltip hidden">
Segna cosa pu√≤ prendere con l‚Äôargento.  
Se non selezioni nulla ‚Üí l‚Äôattaccante sar√† usato come SUPPORTO.
</div>

<label><input type="checkbox" id="chkCitta" onchange="toggleQty('citta')"> Citt√†</label>
<input id="cittaQty" type="number" class="hidden"><br>
<label><input type="checkbox" id="chkPiazza" onchange="toggleQty('piazza')"> PiazzaForte</label>
<input id="piazzaQty" type="number" class="hidden"><br>
<label><input type="checkbox" id="chkCastello" onchange="toggleQty('castello')"> Castello</label>
<input id="castelloQty" type="number" class="hidden"><br><br>

<button class="btn-primary" onclick="salvaAttaccante()">Aggiungi</button>
</div>

<div class="section">
<h2>üë• Attaccanti</h2>
<div id="listaAttaccanti"></div>
</div>

<!-- Truppe necessarie -->
<div class="section">
<h2>‚öôÔ∏è Truppe necessarie <span class="help" onclick="toggleHelp('h3')">?</span></h2>
<div id="h3" class="tooltip hidden">Inserisci le truppe minime richieste per ogni habitat.</div>

Citt√† <input id="reqCitta" type="number"><div id="errReqCitta" class="error hidden">Campo obbligatorio</div><br><br>
PiazzaForte <input id="reqPiazza" type="number"><div id="errReqPiazza" class="error hidden">Campo obbligatorio</div><br><br>
Castello <input id="reqCastello" type="number"><div id="errReqCastello" class="error hidden">Campo obbligatorio</div>
</div>

<!-- Inserimento link principale -->
<div class="section">
<h2>üîó Inserisci link <span class="help" onclick="toggleHelp('h4')">?</span></h2>
<div id="h4" class="tooltip hidden">Inserisci un link per riga.</div>
<textarea id="linkInput"></textarea><br>
<button class="btn-primary" onclick="analizzaLink()">Analizza</button>
<button class="btn-secondary" onclick="assegnaLink()">Assegna</button>
</div>

<!-- Nuovi link (solo giorno/ora) -->
<div class="section">
<h2>üïí Altri link (solo ora/giorno) <span class="help" onclick="toggleHelp('h5')">?</span></h2>
<div id="h5" class="tooltip hidden">Questi link useranno tutti gli attaccanti gi√† inseriti ma senza unit√† n√© argento.</div>
<textarea id="linkFake"></textarea><br>
Giorno <input id="giornoFake" placeholder="GG/MM"><div id="errGiornoFake" class="error hidden">Campo obbligatorio</div><br>
Ora <input id="oraFake" placeholder="HH:MM"><div id="errOraFake" class="error hidden">Campo obbligatorio</div><br>
<button class="btn-secondary" onclick="assegnaFake()">Assegna fake</button>
</div>

<!-- Lista target -->
<div class="section">
<h2>üìë Target</h2>
<div id="listaLink"></div><br>
<button class="btn-secondary" onclick="exportCoordinato()">üì§ Export Tutto</button>
<button class="btn-secondary" onclick="exportSoloReal()">üì§ Export Real</button>
<button class="btn-secondary" onclick="exportSoloFake()">üì§ Export Fake</button>
</div>

<script>
let attaccanti=[], linkList=[];

function toggleHelp(id){const e=document.getElementById(id); e.style.display=e.style.display==="block"?"none":"block";}
function toggleQty(t){document.getElementById(t+"Qty").classList.toggle("hidden");}
function resetError(id){document.getElementById(id).classList.add("hidden");document.getElementById(id.replace("err","")).classList.remove("error");}

function salvaAttaccante(){
  ["errNome","errOff"].forEach(resetError);
  let valid=true;
  if(!nome.value){document.getElementById("errNome").classList.remove("hidden");nome.classList.add("error"); valid=false;}
  if(!off.value){document.getElementById("errOff").classList.remove("hidden");off.classList.add("error"); valid=false;}
  if(!valid) return;

  const a={nome:nome.value, off:+off.value||0, argento:{
    citta:chkCitta.checked?+cittaQty.value||0:0,
    piazza:chkPiazza.checked?+piazzaQty.value||0:0,
    castello:chkCastello.checked?+castelloQty.value||0:0
  }};
  a.supporto=!a.argento.citta&&!a.argento.piazza&&!a.argento.castello;
  attaccanti.push(a);
  mostraAttaccanti();
  salva();

  nome.value=""; off.value=""; 
  chkCitta.checked=false; cittaQty.value=""; cittaQty.classList.add("hidden");
  chkPiazza.checked=false; piazzaQty.value=""; piazzaQty.classList.add("hidden");
  chkCastello.checked=false; castelloQty.value=""; castelloQty.classList.add("hidden");
}

function mostraAttaccanti(){
  listaAttaccanti.innerHTML=attaccanti.map(a=>`
    <div class="card">
      <b>${a.nome}</b> ${a.supporto?"(SUPPORTO)":""}<br>
      OFF ${a.off}<br>
      C:${a.argento.citta} PF:${a.argento.piazza} CA:${a.argento.castello}
    </div>`).join("");
}

function analizzaLink(){
  ["errGiorno","errOra"].forEach(resetError);
  let valid=true;
  if(!giorno.value){document.getElementById("errGiorno").classList.remove("hidden");giorno.classList.add("error"); valid=false;}
  if(!ora.value){document.getElementById("errOra").classList.remove("hidden");ora.classList.add("error"); valid=false;}
  if(!valid) return;

  linkInput.value.split("\n").forEach(r=>{
    if(!r.trim()) return;
    let t=null;
    if(r.toLowerCase().includes("citt")) t="citta";
    if(r.toLowerCase().includes("piazza")) t="piazza";
    if(r.toLowerCase().includes("castello")) t="castello";
    if(t) linkList.push({url:r,tipo:t,dettagli:[],giorno:giorno.value,ora:ora.value,real:true});
  });
  mostraLink();
  salva();
}

function assegnaLink(){
  ["errReqCitta","errReqPiazza","errReqCastello"].forEach(resetError);
  let valid=true;
  if(!reqCitta.value){document.getElementById("errReqCitta").classList.remove("hidden");reqCitta.classList.add("error"); valid=false;}
  if(!reqPiazza.value){document.getElementById("errReqPiazza").classList.remove("hidden");reqPiazza.classList.add("error"); valid=false;}
  if(!reqCastello.value){document.getElementById("errReqCastello").classList.remove("hidden");reqCastello.classList.add("error"); valid=false;}
  if(!valid) return;

  if(attaccanti.length===0){alert("Devi inserire almeno un attaccante!"); return;}

  linkList.forEach(l=>{
    if(!l.real) return;
    l.dettagli=[];
    let req={citta:+reqCitta.value,piazza:+reqPiazza.value,castello:+reqCastello.value}[l.tipo];
    let rest=req;
    attaccanti.forEach(a=>{
      if(rest<=0||a.supporto) return;
      let q=a.argento[l.tipo]||0;
      if(q>0){let use=Math.min(q,rest); rest-=use; l.dettagli.push({nome:a.nome,truppe:use,tipo:"ARGENTO",hab:l.tipo});}
    });
    attaccanti.forEach(a=>{
      if(rest<=0||!a.supporto) return;
      let use=Math.min(a.off,rest); rest-=use; l.dettagli.push({nome:a.nome,truppe:use,tipo:"OFF",hab:l.tipo}); 
    });
  });
  mostraLink();
  salva();
}

function assegnaFake(){
  ["errGiornoFake","errOraFake"].forEach(resetError);
  let valid=true;
  if(!giornoFake.value){document.getElementById("errGiornoFake").classList.remove("hidden");giornoFake.classList.add("error"); valid=false;}
  if(!oraFake.value){document.getElementById("errOraFake").classList.remove("hidden");oraFake.classList.add("error"); valid=false;}
  if(!valid) return;

  if(attaccanti.length===0){alert("Devi inserire almeno un attaccante!"); return;}

  linkFake.value.split("\n").forEach(r=>{
    if(!r.trim()) return;
    attaccanti.forEach(a=>{
      linkList.push({url:r,tipo:"fake",dettagli:[{nome:a.nome,truppe:0,tipo:"FAKE",hab:"fake"}],giorno:giornoFake.value,ora:oraFake.value,real:false});
    });
  });
  mostraLink();
  salva();
}

function mostraLink(){
  listaLink.innerHTML=linkList.map((l,i)=>`
    <div class="card">
      <b>Target ${i+1} - ${l.real?"REAL":"FAKE"}</b><br>
      ${l.url}<br>
      Impatto ${l.giorno} ${l.ora}<br>
      ${l.dettagli.map(d=>`‚Ä¢ ${d.nome} ${d.truppe} (${d.tipo})`).join("<br>")}
    </div>`).join("");
}

function exportCoordinato(){exportFile("all");}
function exportSoloReal(){exportFile("real");}
function exportSoloFake(){exportFile("fake");}

function exportFile(tipo){
  let out={};
  linkList.forEach(l=>{
    if(tipo==="real"&&l.real===false) return;
    if(tipo==="fake"&&l.real===true) return;
    l.dettagli.forEach(d=>{
      if(!out[d.nome]) out[d.nome]=[];
      out[d.nome].push({link:l.url,giorno:l.giorno,ora:l.ora,truppe:d.truppe,tipo:d.tipo,hab:d.hab});
    });
  });
  let txt="";
  for(let n in out){
    txt+=`=== ${n} ===\n`;
    out[n].forEach(r=>{
      txt+=`${r.tipo} ${r.hab.toUpperCase()}\n`;
      txt+=`Link: ${r.link}\n`;
      txt+=`Impatto: ${r.giorno} ${r.ora}\n`;
      txt+=`Truppe: ${r.truppe}\n\n`;
    });
    txt+="----------------------\n\n";
  }
  const b=new Blob([txt],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="coordinato.txt";
  a.click();
}

function salva(){
  localStorage.setItem("coord",JSON.stringify({
    attaccanti,linkList,
    req:{c:reqCitta.value,p:reqPiazza.value,ca:reqCastello.value},
    imp:{g:giorno.value,o:ora.value}, impFake:{g:giornoFake.value,o:oraFake.value}
  }));
}

window.onload=()=>{
  const d=JSON.parse(localStorage.getItem("coord"));
  if(!d||!confirm("Ripristinare dati salvati?"))return;
  attaccanti=d.attaccanti||[];
  linkList=d.linkList||[];
  reqCitta.value=d.req.c;
  reqPiazza.value=d.req.p;
  reqCastello.value=d.req.ca;
  giorno.value=d.imp.g;
  ora.value=d.imp.o;
  giornoFake.value=d.impFake.g;
  oraFake.value=d.impFake.o;
  mostraAttaccanti();
  mostraLink();
};
</script>
</body>
</html>
